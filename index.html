<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Subnautica 3D Prototype</title>
  <style>
    body { margin:0; overflow:hidden; background: #003; }
    #hud {
      position:absolute; left:10px;top:10px; color:#fff;
      background:rgba(0,0,40,0.7); padding:10px; border-radius:8px; font-family:sans-serif; font-size:18px; z-index:10;
      user-select:none;
    }
    #oxygenBar {
      width:220px; height:22px; background:#003d55; border:1px solid #7ef; border-radius:10px; margin-top:10px;
    }
    #oxygenFill {
      width:100%; height:100%; background:#7ef; border-radius:10px 0 0 10px;
      transition: width 0.4s;
    }
    #buildMenu {
      display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:rgba(0,30,60,0.92); color:#fff; padding:24px 40px; border-radius:16px; font-size:18px; z-index:100;
      box-shadow:0 0 32px #000a;
      min-width:320px;
    }
    #buildMenu button {
      display:block; width:100%; margin:8px 0; padding:12px; font-size:18px; border-radius:8px; border:none; background:#159; color:#fff; cursor:pointer;
      transition: background 0.2s;
    }
    #buildMenu button:hover { background:#37f; }
    #craftPanel {
      position:absolute; right:12px; top:10px; color:#fff; background:rgba(0,30,60,0.7); padding:8px; border-radius:6px; font-family:sans-serif; font-size:15px; z-index:10;
    }
    #craftMsg { margin-top:6px;}
  </style>
</head>
<body>
  <div id="hud">
    <div id="info"></div>
    <div id="inventory"></div>
    <div id="oxygenBar"><div id="oxygenFill"></div></div>
  </div>
  <div id="buildMenu">
    <h2>Menu de Construção</h2>
    <button onclick="build('base')">Construir Base Subaquática (8 Peixes, 4 Plantas)</button>
    <button onclick="build('veiculo')">Construir Veículo (12 Peixes, 10 Plantas)</button>
    <button onclick="closeBuildMenu()">Fechar [TAB]</button>
    <div id="buildMsg" style="margin-top:10px;"></div>
  </div>
  <div id="craftPanel">
    <b>Crafting</b><br>
    <button onclick="craftItem()">Construir Faca (2 Peixes, 3 Plantas)</button>
    <div id="craftMsg"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/controls/PointerLockControls.js"></script>
  <script>
    // --- Setup Three.js ---
    const scene = new THREE.Scene();

    // Céu azul gradiente (hemisférica)
    scene.background = new THREE.Color(0x7ed6ff);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 200);
    camera.position.set(0, 2, 0);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Iluminação
    scene.add(new THREE.HemisphereLight(0x7ed6ff, 0x223344, 0.53));
    const sun = new THREE.DirectionalLight(0xcceeff, 2.5);
    sun.position.set(10,80,20);
    scene.add(sun);

    // --- Mar (superfície) ---
    const waterGeo = new THREE.PlaneGeometry(120,120,32,32);
    const waterMat = new THREE.MeshPhongMaterial({color:0x1db7ff, transparent:true, opacity:0.62, shininess:130});
    const water = new THREE.Mesh(waterGeo, waterMat);
    water.position.y = 0;
    water.rotation.x = -Math.PI/2;
    scene.add(water);

    // --- Fundo do mar (solo modelado) ---
    function generateSeabedGeometry(size, segments) {
      const geo = new THREE.PlaneGeometry(size, size, segments, segments);
      for (let i = 0; i < geo.attributes.position.count; i++) {
        let x = geo.attributes.position.getX(i);
        let z = geo.attributes.position.getZ(i);
        let y = Math.sin(x/8)*Math.cos(z/7)*1.5 + Math.random()*0.7 + (Math.sin(z/4)*0.7);
        geo.attributes.position.setY(i, y - 7);
      }
      geo.computeVertexNormals();
      return geo;
    }
    const seabed = new THREE.Mesh(
      generateSeabedGeometry(120, 70),
      new THREE.MeshPhongMaterial({color:0x208672, flatShading:true})
    );
    seabed.rotation.x = -Math.PI/2;
    seabed.position.y = -8;
    scene.add(seabed);

    // --- Rochas do fundo ---
    for(let i=0;i<22;i++){
      const rock = new THREE.Mesh(
        new THREE.DodecahedronGeometry(Math.random()+0.7),
        new THREE.MeshPhongMaterial({color:0x4e4857})
      );
      let x = (Math.random()-0.5)*110, z = (Math.random()-0.5)*110;
      let y = -7.2 + Math.sin(x/9)*0.5 + Math.cos(z/8)*0.6;
      rock.position.set(x, y, z);
      scene.add(rock);
    }

    // --- Plantas ---
    let plants = [];
    for(let i=0;i<36;i++){
      let x = (Math.random()-0.5)*110, z = (Math.random()-0.5)*110;
      let y = -6.4 + Math.sin(x/8)*1 + Math.cos(z/10)*1;
      const plant = new THREE.Mesh(
        new THREE.CylinderGeometry(0.12,0.16,2.2+Math.random()*1.6,8),
        new THREE.MeshPhongMaterial({color:0x15e394})
      );
      plant.position.set(x, y, z);
      scene.add(plant);
      plants.push(plant);
    }

    // --- Criaturas (peixes) ---
    let creatures = [];
    function spawnCreature(){
      let color = Math.random()<0.5 ? 0x00bbff : 0xffaa22;
      let geo = new THREE.CapsuleGeometry(0.34, 0.7, 6, 12);
      let mat = new THREE.MeshPhongMaterial({color:color});
      let fish = new THREE.Mesh(geo, mat);
      let px = (Math.random()-0.5)*90, pz = (Math.random()-0.5)*90, py = -5+Math.random()*9;
      fish.position.set(px, py, pz);
      fish.userData = {dir: Math.random()*Math.PI*2, alive:true, speed:0.08+Math.random()*0.06};
      scene.add(fish);
      creatures.push(fish);
    }
    for(let i=0;i<22;i++) spawnCreature();

    // --- Bases e veículos construídos
    let bases = [];
    let vehicles = [];

    // --- Recursos coletados ---
    let inventory = {peixe:0, planta:0, faca:0};

    // --- HUD ---
    const infoDiv = document.getElementById('info');
    const invDiv = document.getElementById('inventory');
    const craftMsgDiv = document.getElementById('craftMsg');
    const oxygenBar = document.getElementById('oxygenFill');
    function updateHUD(){
      invDiv.textContent = `Peixes: ${inventory.peixe} | Plantas: ${inventory.planta} | Faca: ${inventory.faca ? "Sim" : "Não"} | Bases: ${bases.length} | Veículos: ${vehicles.length}`;
    }
    updateHUD();

    // --- Sistema de oxigênio ---
    let oxygen = 100;
    let maxOxygen = 100;
    let underwater = true;
    let dead = false;
    function updateOxygenBar() {
      oxygenBar.style.width = Math.max(oxygen,0)/maxOxygen*100 + '%';
      oxygenBar.style.background = oxygen > 25 ? "#7ef" : "#f44";
    }

    // --- Controles FPS ---
    const controls = new THREE.PointerLockControls(camera, document.body);

    // Trava mouse ao entrar
    window.onload = () => {
      controls.lock();
    };
    controls.addEventListener('lock', ()=>{});
    controls.addEventListener('unlock', ()=>{});

    let vel = {f:0,b:0,l:0,r:0,up:0,down:0};
    let emergindo = false, mergulhando = false;
    window.addEventListener('keydown',e=>{
      if(document.activeElement.tagName==="INPUT") return;
      if(e.code==="KeyW") vel.f=1;
      if(e.code==="KeyS") vel.b=1;
      if(e.code==="KeyA") vel.l=1;
      if(e.code==="KeyD") vel.r=1;
      if(e.code==="Space") emergindo=true;
      if(e.code==="ControlLeft") mergulhando=true;
      if(e.code==="Tab") { e.preventDefault(); toggleBuildMenu(); }
    });
    window.addEventListener('keyup',e=>{
      if(e.code==="KeyW") vel.f=0;
      if(e.code==="KeyS") vel.b=0;
      if(e.code==="KeyA") vel.l=0;
      if(e.code==="KeyD") vel.r=0;
      if(e.code==="Space") emergindo=false;
      if(e.code==="ControlLeft") mergulhando=false;
    });

    // --- Interação: coletar criaturas/planta ---
    window.addEventListener('mousedown',()=>{
      if(buildMenuOpen) return;
      // Raycast para interagir
      let ray = new THREE.Raycaster();
      let dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
      ray.set(camera.position, dir);
      // Checar criaturas
      let fishHits = ray.intersectObjects(creatures);
      for(let hit of fishHits){
        let fish = hit.object;
        if(fish.userData.alive && hit.distance<3){
          fish.userData.alive=false;
          fish.material.color.set(0x555555);
          inventory.peixe++;
          craftMsgDiv.textContent = "Você coletou um peixe!";
          updateHUD();
          break;
        }
      }
      // Checar plantas
      let plantHits = ray.intersectObjects(plants);
      for(let hit of plantHits){
        let plant = hit.object;
        if(hit.distance<3){
          scene.remove(plant);
          plants = plants.filter(p=>p!==plant);
          inventory.planta++;
          craftMsgDiv.textContent = "Você coletou uma planta!";
          updateHUD();
          break;
        }
      }
    });

    // --- Crafting ---
    function craftItem(){
      if(inventory.faca>0){
        craftMsgDiv.textContent = "Você já tem uma faca!";
        return;
      }
      if(inventory.peixe>=2 && inventory.planta>=3){
        inventory.peixe-=2;
        inventory.planta-=3;
        inventory.faca=1;
        craftMsgDiv.textContent = "Você construiu uma Faca!";
        updateHUD();
      }else{
        craftMsgDiv.textContent = "Faltam recursos!";
      }
    }
    window.craftItem = craftItem;

    // --- Menu de construção ---
    let buildMenuOpen = false;
    function toggleBuildMenu() {
      buildMenuOpen = !buildMenuOpen;
      document.getElementById("buildMenu").style.display = buildMenuOpen ? "block" : "none";
      if(buildMenuOpen) controls.unlock();
      else controls.lock();
    }
    function closeBuildMenu() {
      buildMenuOpen = false;
      document.getElementById("buildMenu").style.display = "none";
      controls.lock();
    }
    window.closeBuildMenu = closeBuildMenu;

    function build(tipo) {
      let msg = '';
      if(tipo==='base') {
        if(inventory.peixe>=8 && inventory.planta>=4){
          inventory.peixe -= 8;
          inventory.planta -= 4;
          // Cria módulo base
          let base = new THREE.Mesh(
            new THREE.CylinderGeometry(2,2,2.4,18),
            new THREE.MeshPhongMaterial({color:0x9cf, flatShading:true, transparent:true, opacity:0.91})
          );
          let pos = camera.position.clone().add(new THREE.Vector3(0,-2,-5).applyQuaternion(camera.quaternion));
          base.position.copy(pos);
          scene.add(base);
          bases.push(base);
          msg = "Base construída!";
        } else msg = "Faltam recursos!";
      }
      if(tipo==='veiculo') {
        if(inventory.peixe>=12 && inventory.planta>=10){
          inventory.peixe -= 12;
          inventory.planta -= 10;
          // Cria veículo
          let veic = new THREE.Group();
          let corpo = new THREE.Mesh(
            new THREE.CapsuleGeometry(0.7,3,8,16),
            new THREE.MeshPhongMaterial({color:0xf5e099, transparent:true, opacity:0.96})
          );
          corpo.rotation.z = Math.PI/2;
          veic.add(corpo);
          let dome = new THREE.Mesh(
            new THREE.SphereGeometry(0.7,12,12,0,Math.PI),
            new THREE.MeshPhongMaterial({color:0x7ef, transparent:true, opacity:0.65})
          );
          dome.position.x = 1.7;
          veic.add(dome);
          let pos = camera.position.clone().add(new THREE.Vector3(0,-1.7,-8).applyQuaternion(camera.quaternion));
          veic.position.copy(pos);
          veic.rotation.y = camera.rotation.y+Math.PI/2;
          scene.add(veic);
          vehicles.push(veic);
          msg = "Veículo construído!";
        } else msg = "Faltam recursos!";
      }
      document.getElementById("buildMsg").textContent = msg;
      updateHUD();
    }
    window.build = build;

    // --- Loop principal ---
    function animate(){
      requestAnimationFrame(animate);

      // --- Movimento FPS ---
      let speed = underwater ? 0.14 : 0.17;
      let dir = new THREE.Vector3();
      if(vel.f) dir.z -= speed;
      if(vel.b) dir.z += speed;
      if(vel.l) dir.x -= speed;
      if(vel.r) dir.x += speed;
      controls.moveRight(dir.x);
      controls.moveForward(dir.z);

      // Emergir e mergulhar
      let waterLevel = 0;
      if(emergindo && camera.position.y < waterLevel+0.1) camera.position.y += 0.16;
      if(mergulhando && camera.position.y > -7.2) camera.position.y -= 0.13;

      // Limitar acima e abaixo
      camera.position.y = Math.max(-7.8, Math.min(camera.position.y, 3.8));

      // --- Checa se está debaixo d'água ---
      underwater = camera.position.y < waterLevel-0.1;

      // --- Sistema de oxigênio ---
      if(underwater) {
        oxygen -= 0.09;
        if(oxygen <= 0 && !dead) {
          oxygen = 0;
          dead = true;
          alert("Você ficou sem oxigênio! Volte à superfície para respirar.");
        }
      } else {
        oxygen = Math.min(maxOxygen, oxygen+0.5);
        if(dead && oxygen>30) dead = false;
      }
      updateOxygenBar();

      // --- Movimento criaturas ---
      for(let fish of creatures){
        if(fish.userData.alive){
          // Nada em direção aleatória, muda de vez em quando
          if(Math.random()<0.013) fish.userData.dir += (Math.random()-0.5)*0.6;
          fish.position.x += Math.cos(fish.userData.dir)*fish.userData.speed;
          fish.position.z += Math.sin(fish.userData.dir)*fish.userData.speed;
          fish.position.y += (Math.random()-0.5)*0.04;
          // Limite fundo
          fish.position.x = Math.max(-55,Math.min(55,fish.position.x));
          fish.position.z = Math.max(-55,Math.min(55,fish.position.z));
          fish.position.y = Math.max(-7,Math.min(-0.8,fish.position.y));
          fish.rotation.y = -fish.userData.dir;
        }
      }

      // --- HUD Info ---
      let profundidade = Math.max(0,Math.floor(waterLevel-camera.position.y));
      infoDiv.textContent = `Profundidade: ${profundidade}m | Use TAB para construir. [Espaço: emergir, Ctrl: mergulhar]`;

      renderer.render(scene, camera);
    }
    animate();

    // --- Responsivo ---
    window.addEventListener('resize',()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // --- Desabilitar scroll com espaço/tab ---
    window.addEventListener('keydown', function(e) {
      if(["Space", "Tab"].includes(e.code)) e.preventDefault();
    });
  </script>
</body>
</html>
